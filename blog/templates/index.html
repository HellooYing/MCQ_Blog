{% load staticfiles %}
<!DOCTYPE HTML>
<html>

<head>
    <title>从未想过如此之好</title>
    <link rel="stylesheet" href="../static/css/style.css">
    <link rel="shortcut icon" href="../static/favicon.ico" type="image/x-icon" />
</head>

<body>
    <div id="nav_left" class="nav_left">
        <div class="nav_left_head">
            <span>毛草球</span>
        </div>
        <div class="nav_left_word">
            <span>Space,the final frontier.</span>
        </div>
        <div class="nav_left_content">
            <a>Home</a>
            <a>Categories</a>
            <a>…</a>
        </div>
    </div>
    <div id="water">
    </div>
</body>

<script src="../static/js/jquery-1.11.1.min.js"></script>

<script type="text/javascript">
    function main() {
        var strlen = {};
        var width = document.body.clientWidth;
        var num = Math.floor(width * 0.77 / 236);
        var nav_width = width * 0.21;
        var drip_width = width * 0.76 / num;
        var drip_left = (drip_width - 220) / 2
        var drip_height = new Array();
        var list = new Array();
        var drips_left = new Array();

        strlen.GetLength = function (str) {
            var realLength = 0, len = str.length, charCode = -1;
            for (var i = 0; i < len; i++) {
                charCode = str.charCodeAt(i);
                if (charCode >= 0 && charCode <= 128)
                    realLength += 1;
                else
                    realLength += 2;
            }
            return realLength;
        };

        $.ajax({
            async: false,
            url: "/index_waterfall",
            success: function (result) {
                for (var n = 0; n < num; n++) {
                    list[n] = 0;
                    drips_left[n] = drip_width * n + drip_left + nav_width
                }
                var i1 = result.length + 1;
                load(i1)
                function load(load1) {
                    for (i = load1; i > load1 - 18 && i > 1; i--) {
                        var min = Math.min.apply(null, list)
                        title_len = strlen.GetLength(result['title[' + i + ']'])
                        brief_len = strlen.GetLength(result['brief[' + i + ']'])
                        console.log(strlen.GetLength(result['title[29]']))
                        var title_add_height;
                        var brief_add_height;
                        if (title_len < 15) {
                            title_add_height = 0;
                        }
                        else if (title_len < 31) {
                            title_add_height = 20;
                        }
                        else if (title_len < 46) {
                            title_add_height = 40;
                        }
                        else {
                            title_add_height = 60;
                        }
                        if (brief_len < 32) {
                            brief_add_height = 0;
                        }
                        else if (brief_len < 64) {
                            brief_add_height = 16;
                        }
                        else if (brief_len < 96) {
                            brief_add_height = 32;
                        }
                        else {
                            brief_add_height = 48;
                        }
                        drip_height[i] = drip_width / result['wch[' + i + ']'] + 70 + title_add_height + brief_add_height
                        var a = document.createElement("div");
                        a.className = "drip";
                        a.id = "drip" + i;
                        a.style.minHeight = drip_height[i] + 'px';
                        for (var n = 0; n < num; n++) {
                            if (list[n] == min) {
                                a.style.left = drips_left[n] + 'px';
                                a.style.top = list[n] + 200 + 'px';
                                list[n] = list[n] + drip_height[i] + 35;
                                break;
                            }
                        }
                        document.getElementById("water").appendChild(a);
                        var b = document.createElement("a");
                        b.className = "content";
                        b.id = "content" + i;
                        b.href = "#";
                        document.getElementById("drip" + i).appendChild(b);
                        var c = document.createElement("div");
                        c.className = "picture";
                        c.id = "picture" + i;
                        document.getElementById("content" + i).appendChild(c);
                        var d = document.createElement("img");
                        d.src = result['picture[' + i + ']'];
                        document.getElementById("picture" + i).appendChild(d);
                        var e = document.createElement("div");
                        e.className = "title";
                        e.id = "title" + i;
                        document.getElementById("content" + i).appendChild(e);
                        var f = document.createElement("span");
                        var g = document.createTextNode(result['title[' + i + ']']);
                        f.appendChild(g);
                        document.getElementById("title" + i).appendChild(f);
                        var h = document.createElement("div");
                        h.className = "brief";
                        h.id = "brief" + i;
                        document.getElementById("content" + i).appendChild(h);
                        var j = document.createElement("span");
                        var k = document.createTextNode(result['brief[' + i + ']']);
                        j.appendChild(k);
                        document.getElementById("brief" + i).appendChild(j);
                        Window.newload = i - 1;
                    }                
}
                $(window).scroll(function () {
                    var scrollTop = $(this).scrollTop();
                    var scrollHeight = $(document).height();
                    var clientHeight = $(this).height();
                    if (scrollTop + clientHeight >= scrollHeight && Window.newload > 2) {
                        load(Window.newload)
                    }
                });
            }
        });
    }
    function sleep(numberMillis) {
        var now = new Date();
        var exitTime = now.getTime() + numberMillis;
        while (true) {
            now = new Date();
            if (now.getTime() > exitTime)
                return;
        }
    }
    main()
    window.onresize = function () {
        var parent = document.body;
        var child = document.getElementById("water");
        parent.removeChild(child);
        var water = document.createElement("div");
        water.id = "water";
        document.body.appendChild(water);
        main()
        sleep(180)
    }
</script>

</html>